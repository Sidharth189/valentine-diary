<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Edit Diary</title>
    <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&display=swap" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            font-family: 'Indie Flower', cursive;
            background-color: #8d6e63;
            /* Vertical Wood Texture - Lighter */
            background-image:
                repeating-linear-gradient(90deg,
                    rgba(255, 255, 255, 0.05) 0px,
                    rgba(255, 255, 255, 0.05) 1px,
                    transparent 1px,
                    transparent 40px),
                linear-gradient(to bottom, #a1887f 0%, #6d4c41 100%);
            background-size: 40px 100%, 100% 100%;
            margin: 0;
            padding: 10px;
            color: #333;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }

        .dashboard-layout {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* Reduced gap */
            align-items: center;
        }

        /* --- 1. Top Section: Payment --- */
        .status-bar {
            width: 100%;
            background: #fff;
            padding: 8px;
            /* Compact */
            transform: rotate(-1deg);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            text-align: center;
            border-radius: 2px;
            position: relative;
            z-index: 200;
        }

        .status-bar::after {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #e74c3c, #c0392b);
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            font-size: 2rem;
            margin: 10px;
            transform: rotate(-2deg);
        }

        /* --- 2. Middle Section: Stacked Pages --- */
        #pages-stack-container {
            width: 100%;
            height: 600px;
            /* Increased Height for better writing space */
            position: relative;
            perspective: 1000px;
        }

        .page-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fffbf0;
            padding: 20px 30px 20px 50px;
            box-sizing: border-box;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 2px;

            /* Lined Paper Lines */
            background-image: linear-gradient(rgba(0, 0, 0, 0.1) 1px, transparent 1px);
            background-size: 100% 25px;
            line-height: 25px;

            /* Initial state: Hidden/Stacked */
            opacity: 0;
            transform: translateX(100%) rotate(10deg);
            pointer-events: none;
            z-index: 0;
            display: flex;
            flex-direction: column;
        }

        .page-item::before {
            display: none;
        }

        /* Active Page State */
        .page-item.active {
            opacity: 1;
            transform: translateX(0) rotate(-1deg);
            pointer-events: all;
            z-index: 10;
        }

        .page-number {
            position: absolute;
            top: -10px;
            right: -5px;
            background: #e74c3c;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            border: 2px solid #fff;
            z-index: 20;
        }

        label {
            display: inline-block;
            font-weight: bold;
            margin-top: 5px;
            padding: 0 5px;
            font-size: 0.9rem;
        }

        textarea,
        input[type="text"] {
            width: 100%;
            padding: 0;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 1.15rem;
            line-height: 30px;
            resize: none;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        /* Dynamic Height Textarea */
        textarea {
            height: calc(100% - 140px);
            /* Fill remaining space */
            margin-top: 5px;
        }

        input[type="text"] {
            height: auto;
        }

        textarea:focus,
        input:focus {
            outline: none;
            background: rgba(41, 128, 185, 0.05);
            /* Subtle blue highlight */
            caret-color: #c0392b;
            /* Red Cursor */
        }

        /* Specific override to ensure cursor visibility */
        textarea {
            caret-color: #c0392b;
        }

        /* --- 3. Controls --- */
        .stack-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            background: rgba(255, 255, 255, 0.15);
            padding: 5px 15px;
            border-radius: 50px;
            backdrop-filter: blur(5px);
            margin-top: 20px;
        }

        .nav-btn {
            background: #fff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            color: #5d4037;
        }

        .nav-btn:hover {
            transform: scale(1.1);
            background: #f1c40f;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #ddd;
        }

        .btn-delete {
            position: absolute;
            bottom: 10px;
            right: 15px;
            background: transparent;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .btn-delete:hover {
            opacity: 1;
            color: #c0392b;
            transform: scale(1.1);
        }

        /* --- 4. Bottom Actions (Redesigned) --- */
        .action-bar {
            width: 100%;
            display: flex;
            flex-direction: row;
            gap: 30px;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        /* Wax Seal (Save) */
        .wax-seal-btn {
            width: 70px;
            height: 70px;
            background: radial-gradient(circle at 30% 30%, #e74c3c, #c0392b);
            border-radius: 50%;
            border: none;
            color: rgba(255, 255, 255, 0.9);
            font-family: 'Dancing Script', cursive;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow:
                0 4px 6px rgba(0, 0, 0, 0.4),
                inset 2px 2px 5px rgba(255, 255, 255, 0.2),
                inset -2px -2px 5px rgba(0, 0, 0, 0.2),
                0 0 0 4px rgba(192, 57, 43, 0.3);
            /* Irregular edge simulation wrapper */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: rotate(-10deg);
        }

        .wax-seal-btn:hover {
            transform: rotate(-10deg) scale(1.1);
        }

        .wax-seal-btn::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }

        /* Vintage Stamp (Preview) */
        .stamp-btn {
            background: #fff;
            border: none;
            padding: 10px 15px;
            position: relative;
            color: #2c3e50;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            text-transform: uppercase;
            letter-spacing: 2px;
            transform: rotate(5deg);
            transition: transform 0.2s;

            /* Serrated Edges using radial gradient mask */
            --r: 3px;
            /* radius of circles */
            background: radial-gradient(var(--r) at var(--r) var(--r), #0000 98%, #fffbf0) 0 0 / calc(100% - var(--r)) calc(100% - var(--r)) no-repeat,
                radial-gradient(var(--r) at calc(100% - var(--r)) var(--r), #0000 98%, #fffbf0) 100% 0 / calc(100% - var(--r)) calc(100% - var(--r)) no-repeat,
                radial-gradient(var(--r) at var(--r) calc(100% - var(--r)), #0000 98%, #fffbf0) 0 100% / calc(100% - var(--r)) calc(100% - var(--r)) no-repeat,
                radial-gradient(var(--r) at calc(100% - var(--r)) calc(100% - var(--r)), #0000 98%, #fffbf0) 100% 100% / calc(100% - var(--r)) calc(100% - var(--r)) no-repeat,
                linear-gradient(#fffbf0 0 0) center/ calc(100% - 2*var(--r)) calc(100% - 2*var(--r)) no-repeat,
                radial-gradient(circle at 50% 50%, #fffbf0 0%, #fffbf0 100%);
            /* Simple fallback background if the complex mask is too much, let's stick to a simpler "Postage" look */
            background: #fdfbf7;
            border: 2px dashed #bdc3c7;
            outline: 4px solid #fdfbf7;
        }

        .stamp-btn:hover {
            transform: rotate(5deg) scale(1.1);
            background: #ecf0f1;
        }

        .stamp-text {
            border: 1px solid #333;
            padding: 2px 5px;
            display: inline-block;
            transform: rotate(-2deg);
        }

        .unpaid {
            color: #c0392b;
        }

        /* Polaroid Sync for Dashboard */
        .polaroid-preview {
            background: white;
            padding: 8px 8px 25px 8px;
            /* Classic polaroid bottom bar */
            border: 1px solid #ddd;
            box-shadow: 2px 4px 10px rgba(0, 0, 0, 0.1);
            transform: rotate(-1deg);
            display: inline-block;
            margin: 10px 0;
            max-width: 90%;
        }

        .polaroid-preview img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* Pagination Dots */
        .pagination-container {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 10px 0;
            flex-wrap: wrap;
            max-width: 100%;
        }

        .page-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .page-dot:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .page-dot.active {
            background: #f1c40f;
            color: #6a1b21;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
            transform: scale(1.1);
        }

        /* Lined Input Style */
        .line-input {
            background: transparent;
            border: none;
            border-bottom: 2px dashed #e6c278;
            caret-color: #f1c40f;
            color: #fff;
            text-align: center;
            font-family: 'Indie Flower';
            outline: none;
            transition: border-bottom 0.3s;
        }

        .line-input:focus {
            border-bottom: 2px solid #f1c40f;
        }
    </style>
</head>

<body>
    <div class="dashboard-layout">

        <!-- Logout Button (Top Right) -->
        <a href="/logout"
            style="position:absolute; top:20px; right:20px; color:rgba(255,255,255,0.8); font-size:1.2rem; text-decoration:none; font-weight:bold; background:rgba(0,0,0,0.2); padding:5px 10px; border-radius:5px; transition:all 0.2s;">Logout
            ‚Ü™</a>

        <!-- 1. Payment Status (Top) -->
        <div class="status-bar">
            <span style="font-weight:bold; font-size:1rem; color:#333;">STATUS:</span>
            <span class="<%= diary.isPaid ? 'paid' : 'unpaid' %>" style="font-weight:bold;">
                <%= diary.isPaid ? 'PAID' : 'LOCKED' %>
            </span>
            <% if (!diary.isPaid) { %>
                <button onclick="payNow()"
                    style="background:#c0392b; color:white; border:none; padding:5px 12px; border-radius:20px; cursor:pointer; font-family:inherit; font-weight:bold; margin-left:10px; font-size:0.9rem;">
                    Pay Rs 9 to Unlock</button>
                <% } else { %>
                    <span style="color:#2980b9; margin: 0 5px;">|</span>
                    <a href="/u/<%= diary.slug %>" target="_blank"
                        style="color:#2980b9; text-decoration:none; font-weight:bold;">Visit Link</a>
                    <span style="color:#2980b9; margin: 0 5px;">|</span>
                    <button
                        onclick="navigator.clipboard.writeText(window.location.origin + '/u/<%= diary.slug %>'); alert('Link Copied! üìã')"
                        style="background:none; border:none; color:#2980b9; font-weight:bold; cursor:pointer; font-family:inherit; font-size:1rem; padding:0; text-decoration:underline;"
                        title="Copy to clipboard">Copy Link</button>
                    <% } %>
        </div>

        <h1>My Diary Pages</h1>

        <form id="diary-form" action="/dashboard/save" method="POST" style="width:100%;">

            <!-- 2. Interactive Page Stack -->
            <div id="pages-stack-container">
                <!-- Pages injected via JS -->
            </div>

            <!-- 3. Navigation & Add Controls -->
            <div class="stack-controls">
                <button type="button" class="nav-btn" id="btn-prev" onclick="changePage(-1)">&#8592;</button>
                <div style="text-align:center; color:white;">
                    <span id="current-page-display" style="font-size:1.1rem; font-weight:bold;">Cover</span>
                    <span style="margin:0 5px; opacity:0.5;">|</span>
                    <button type="button" class="btn-add" onclick="addPage()"
                        style="background:none; border:none; color:#f1c40f; text-decoration:underline; cursor:pointer; font-family:inherit; font-weight:bold;">+
                        Add Page</button>
                </div>
                <button type="button" class="nav-btn" id="btn-next" onclick="changePage(1)">&#8594;</button>
            </div>

            <!-- Pagination Dots -->
            <div id="pagination-controls" class="pagination-container"></div>

            <!-- 4. Save & Preview (Bottom) -->
            <div class="action-bar">
                <button type="submit" class="wax-seal-btn" title="Seal & Save">Save</button>
                <div style="width: 20px;"></div> <!-- Spacer -->
                <button type="button" class="stamp-btn" onclick="togglePreview()" title="Preview Diary">
                    <span class="stamp-text">Preview</span>
                </button>
            </div>

            <!-- Inline Preview Container -->
            <div id="preview-container"
                style="display:none; width:100%; margin-top:20px; border:4px solid #fff; border-radius:5px; box-shadow:0 10px 20px rgba(0,0,0,0.3); background:#333; position:relative;">
                <button type="button" onclick="togglePreview()"
                    style="position:absolute; top:-15px; right:-15px; background:red; color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.3);">X</button>
                <div style="color:white; padding:5px; text-align:center; font-size:0.9rem;">Preview Mode (Refresh to see
                    saved changes)</div>
                <iframe id="preview-frame" style="width:100%; height:600px; border:none; background:white;"></iframe>
            </div>

        </form>
    </div>

    <!-- Data -->
    <div id="existing-data" style="display:none;">
        <%= JSON.stringify(diary.pages) %>
    </div>



    <script>
        console.log("Dashboard Script Initializing...");

        // --- Data & State ---
        let pagesData = [];
        try {
            const rawData = document.getElementById('existing-data').textContent;
            pagesData = JSON.parse(rawData);
        } catch (e) {
            console.error("JSON Parse Error", e);
            pagesData = [];
        }

        // Cover Data State (Initialized from EJS)
        let coverData = {
            title: `<%- diary.title %>`,
            description: `<%- diary.description %>`
        };

        // Final Page Data State
        let finalPageData = {
            finalQuestion: `<%- diary.finalQuestion || 'Will you be my Valentine?' %>`,
            yesLabel: `<%- diary.yesLabel || 'Yes! ‚ù§Ô∏è' %>`,
            noLabel: `<%- diary.noLabel || 'No' %>`,
            successMessage: `<%- diary.successMessage || 'Yay! ‚ù§Ô∏è I love you!' %>`
        };

        if (pagesData.length < 1) {
            pagesData.push({ text: '', imageUrl: '' });
        }

        // Start at Cover (-1)
        let currentIndex = -1;

        const container = document.getElementById('pages-stack-container');
        const displayCount = document.getElementById('current-page-display');
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');

        // --- Init ---
        renderStack();
        updateUI();

        // --- Core Functions ---

        function renderStack() {
            container.innerHTML = '';

            // --- 1. RENDER COVER (Index -1) ---
            const coverDiv = document.createElement('div');
            coverDiv.className = 'page-item';

            // Leather Style Cover
            coverDiv.style.background = "#6a1b21";
            coverDiv.style.backgroundImage = "radial-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px), radial-gradient(rgba(0, 0, 0, 0.1) 1px, transparent 1px)";
            coverDiv.style.backgroundSize = "4px 4px, 5px 5px";
            coverDiv.style.border = "none";
            coverDiv.style.boxShadow = "inset 0 0 20px rgba(0,0,0,0.6)";
            coverDiv.style.display = "flex";
            coverDiv.style.flexDirection = "column";
            coverDiv.style.justifyContent = "center";
            coverDiv.style.alignItems = "center";
            coverDiv.style.zIndex = 50;

            if (currentIndex === -1) coverDiv.classList.add('active');
            else if (currentIndex > -1) coverDiv.classList.add('prev');

            coverDiv.innerHTML = `
                <div class="page-number" style="background:#444; color:#fff; border-color:#666;">C</div>
                
                <label style="color:#e6c278; font-size:0.8rem;">Cover Title <small style="color:#ccc;">(<span id="char-count-title">${(coverData.title || '').length}</span>/100)</small></label>
                <input type="text" name="title" maxlength="100" value="${coverData.title}" oninput="coverData.title=this.value; document.getElementById('char-count-title').textContent=this.value.length" placeholder="Title..."
                    style="background:transparent; border:none; border-bottom:2px solid #e6c278; color:#e6c278; font-size:2.5rem; text-align:center; font-family:'Dancing Script'; width:90%; margin-bottom:20px; text-shadow:1px 1px 2px black; outline:none; height:auto;">
                
                <label style="color:#e6c278; font-size:0.8rem;">Cover Description <small style="color:#ccc;">(<span id="char-count-desc">${(coverData.description || '').length}</span>/200)</small></label>
                <textarea name="description" maxlength="200" oninput="coverData.description=this.value; document.getElementById('char-count-desc').textContent=this.value.length" placeholder="Description..."
                    style="background:transparent; border:1px solid #e6c278; color:#fff; width:70%; height:80px !important; flex-grow:0; border-radius:5px; padding:5px; font-family:'Indie Flower'; font-size:1.1rem !important; text-align:center; outline:none;">${coverData.description}</textarea>
            `;
            container.appendChild(coverDiv);

            // --- 2. RENDER PAGES (Index 0..N) ---
            pagesData.forEach((page, index) => {
                const div = document.createElement('div');
                div.className = `page-item`;

                if (index === currentIndex) div.classList.add('active');
                else if (index < currentIndex) div.classList.add('prev');

                const isImageFirst = page.layout === 'image-first';

                const imageSection = `
                    <div style="margin: 0; text-align: center; position:relative; width:100%; display: ${page.imageUrl ? 'block' : 'none'};">
                        <div class="polaroid-preview" style="transform: rotate(${index % 2 === 0 ? '-2deg' : '2deg'});">
                            <img id="preview-${index}" src="${page.imageUrl || ''}">
                        </div>
                        
                        <!-- Upload Button (Floating) -->
                        <label for="file-${index}" title="Upload Image" style="position:absolute; top:10px; right:10px; font-size:1.5rem; cursor:pointer; z-index:15; transition:transform 0.2s; background:rgba(255,255,255,0.7); border-radius:50%; padding:5px;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                            üñºÔ∏è
                        </label>
                        <input type="file" id="file-${index}" accept="image/*" style="display:none;" onchange="handleFileUpload(this, ${index})">
                        <span id="upload-status-${index}" style="position:absolute; top:45px; right:15px; font-size:0.7rem; color:#27ae60; font-weight:bold;"></span>
                    </div>
                    
                    <!-- Placeholder when no image is uploaded -->
                    <div id="image-placeholder-${index}" style="display: ${page.imageUrl ? 'none' : 'block'}; margin: 10px 0; padding: 20px; border: 2px dashed #ccc; text-align:center; position:relative;">
                        <span style="opacity:0.5;">No Photo Added</span>
                        <label for="file-${index}" style="position:absolute; inset:0; cursor:pointer; font-size:0;"></label>
                        <span id="upload-status-placeholder-${index}" style="display:block; font-size:0.7rem; color:#27ae60; font-weight:bold;"></span>
                    </div>`;

                const textSection = `
                    <label style="margin-top:0;">üìù Story: <small style="color:#666; float:right;">(<span id="char-count-${index}">${(page.text || '').length}</span>/500)</small></label>
                    <textarea name="pages[${index}][text]" maxlength="500" placeholder="Once upon a time..." 
                        style="width: 100%; height: 200px; padding: 5px 0; border: none; background: transparent; resize: vertical; line-height: 25px;"
                        oninput="updateData(${index}, 'text', this.value); updateCharCount(this, ${index})">${page.text || ''}</textarea>
                    
                    <input type="hidden" name="pages[${index}][imageUrl]" value="${page.imageUrl}" id="hidden-img-${index}">
                    <input type="hidden" name="pages[${index}][layout]" value="${page.layout || 'text-first'}" id="layout-${index}">`;

                div.innerHTML = `
                    <div class="page-number">${index + 1}</div>
                    
                    <div style="text-align:right; margin-bottom:5px;">
                        <button type="button" onclick="toggleLayout(${index})" style="font-size:0.8rem; padding:2px 5px; background:#bdc3c7; border:none; border-radius:3px; cursor:pointer;" title="Swap Text/Image Position">
                            ${isImageFirst ? '‚¨áÔ∏è Move Image Down' : '‚¨ÜÔ∏è Move Image Up'}
                        </button>
                    </div>

                    ${isImageFirst ? imageSection + textSection : textSection + imageSection}
                    
                    <button type="button" class="btn-delete" onclick="deletePage(${index})">üóëÔ∏è</button>
                `;
                container.appendChild(div);
            });

            // --- 3. RENDER FINAL PAGE (Index pagesData.length) ---
            const finalDiv = document.createElement('div');
            finalDiv.className = 'page-item';

            // Back Cover Style
            finalDiv.style.background = "#6a1b21";
            finalDiv.style.backgroundImage = "radial-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px), radial-gradient(rgba(0, 0, 0, 0.1) 1px, transparent 1px)";
            finalDiv.style.backgroundSize = "4px 4px, 5px 5px";
            finalDiv.style.border = "none";
            finalDiv.style.boxShadow = "inset 0 0 20px rgba(0,0,0,0.6)";
            finalDiv.style.display = "flex";
            finalDiv.style.flexDirection = "column";
            finalDiv.style.justifyContent = "center";
            finalDiv.style.alignItems = "center";
            finalDiv.style.zIndex = 50;

            if (currentIndex === pagesData.length) finalDiv.classList.add('active');
            else if (currentIndex > pagesData.length) finalDiv.classList.add('prev');

            finalDiv.innerHTML = `
                <div class="page-number" style="background:#444; color:#fff; border-color:#666;">End</div>
                
                <h3 style="color:#e6c278; font-family:'Dancing Script'; font-size:2rem; margin-bottom:15px; text-shadow:1px 1px 2px black;">The Big Question</h3>

                <label style="color:#e6c278; font-size:0.8rem;">Question Text</label>
                <input type="text" name="finalQuestion" value="${finalPageData.finalQuestion}" oninput="finalPageData.finalQuestion=this.value" 
                    class="line-input" style="width:80%; font-size:1.2rem; margin-bottom:15px;">

                <div style="display:flex; gap:10px; width:80%; justify-content:center;">
                    <div style="flex:1;">
                        <label style="color:#27ae60; font-size:0.8rem;">'Yes' Button</label>
                        <input type="text" name="yesLabel" value="${finalPageData.yesLabel}" oninput="finalPageData.yesLabel=this.value"
                            class="line-input" style="width:100%; color:#27ae60; border-bottom: 2px dashed #27ae60;">
                    </div>
                    <div style="flex:1;">
                        <label style="color:#c0392b; font-size:0.8rem;">'No' Button</label>
                        <input type="text" name="noLabel" value="${finalPageData.noLabel}" oninput="finalPageData.noLabel=this.value"
                            class="line-input" style="width:100%; color:#c0392b; border-bottom: 2px dashed #c0392b;">
                    </div>
                </div>

                <label style="color:#e6c278; font-size:0.8rem; margin-top:15px;">Success Message</label>
                <input type="text" name="successMessage" value="${finalPageData.successMessage}" oninput="finalPageData.successMessage=this.value"
                    class="line-input" style="width:80%; font-size:1.2rem;">
            `;
            container.appendChild(finalDiv);
        }

        function toggleLayout(index) {
            const currentLayout = pagesData[index].layout || 'text-first';
            pagesData[index].layout = currentLayout === 'image-first' ? 'text-first' : 'image-first';
            renderStack();
        }

        function updateData(index, field, value) {
            pagesData[index][field] = value;
        }

        function updateCharCount(textarea, index) {
            const currentLength = textarea.value.length;
            const counter = document.getElementById(`char-count-${index}`);
            if (counter) counter.textContent = currentLength;
        }

        async function handleFileUpload(input, index) {
            const file = input.files[0];
            if (!file) return;

            const statusSpan = document.getElementById(`upload-status-${index}`);
            statusSpan.textContent = "Uploading...";

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                if (!response.ok) throw new Error("Upload Failed");

                const data = await response.json();
                if (data.imageUrl) {
                    pagesData[index].imageUrl = data.imageUrl;
                    document.getElementById(`hidden-img-${index}`).value = data.imageUrl;
                    const preview = document.getElementById(`preview-${index}`);
                    preview.src = data.imageUrl;
                    preview.style.display = 'inline-block';
                    statusSpan.textContent = "Done!";
                } else {
                    statusSpan.textContent = "Error";
                }
            } catch (err) {
                console.error(err);
                statusSpan.textContent = "Failed";
                alert("Upload failed.");
            }
        }

        async function saveDiary(event) {
            event.preventDefault();

            // Validation: Enforce Odd Page Count
            if (pagesData.length % 2 === 0 && pagesData.length > 0) {
                alert("Please add one more page! \n\nSince the content starts on the inner cover, the diary requires an odd number of pages (1, 3, 5, etc.) to look perfect.");
                return;
            }

            const form = document.getElementById('diary-form');
            const statusDiv = document.getElementById('save-status');

            statusDiv.textContent = "Saving...";
            statusDiv.style.opacity = 1;

            // Prepare Data
            const formData = {
                cover: coverData,
                pages: pagesData
            };

            try {
                const response = await fetch('/save-diary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    statusDiv.innerHTML = "Saved Successfully! üíñ";
                    setTimeout(() => { statusDiv.style.opacity = 0; }, 3000);
                    refreshPreview();
                } else {
                    throw new Error("Save failed");
                }
            } catch (err) {
                console.error(err);
                statusDiv.textContent = "Error Saving!";
                alert("Failed to save diary.");
            }
        }

        function changePage(direction) {
            const newIndex = currentIndex + direction;
            if (newIndex >= -1 && newIndex <= pagesData.length) {
                currentIndex = newIndex;
                renderStack();
                updateUI();
            }
        }

        function addPage() {
            if (pagesData.length >= 10) { alert("Max 10 pages!"); return; }
            pagesData.push({ text: "", imageUrl: "", layout: 'image-first' }); // Default to Image First as per recent change
            currentIndex = pagesData.length - 1;
            renderStack();
            updateUI();
        }

        function deletePage(index) {
            if (pagesData.length <= 1) { alert("Keep at least 1 page!"); return; }
            if (confirm("Delete this page?")) {
                pagesData.splice(index, 1);
                currentIndex = Math.max(-1, index - 1);
                renderStack();
                updateUI();
            }
        }

        function updateUI() {
            if (currentIndex === -1) displayCount.textContent = `Cover`;
            else if (currentIndex === pagesData.length) displayCount.textContent = `Final Page`;
            else displayCount.textContent = `${currentIndex + 1} / ${pagesData.length}`;

            btnPrev.disabled = currentIndex === -1;
            btnNext.disabled = currentIndex === pagesData.length;

            // Hide Add Page button on Cover (-1) and Final Page
            const btnAdd = document.querySelector('.btn-add');
            if (btnAdd) {
                btnAdd.style.display = (currentIndex === -1 || currentIndex === pagesData.length) ? 'none' : 'inline-block';
            }

            renderPagination();
        }

        function renderPagination() {
            const controls = document.getElementById('pagination-controls');
            controls.innerHTML = '';

            // 1. Cover Dot
            const coverDot = document.createElement('div');
            coverDot.className = `page-dot ${currentIndex === -1 ? 'active' : ''}`;
            coverDot.textContent = 'C';
            coverDot.title = "Go to Cover";
            coverDot.onclick = () => { currentIndex = -1; renderStack(); updateUI(); };
            controls.appendChild(coverDot);

            // 2. Page Dots
            pagesData.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = `page-dot ${currentIndex === i ? 'active' : ''}`;
                dot.textContent = i + 1;
                dot.onclick = () => { currentIndex = i; renderStack(); updateUI(); };
                controls.appendChild(dot);
            });

            // 3. Final Page Dot
            const finalDot = document.createElement('div');
            finalDot.className = `page-dot ${currentIndex === pagesData.length ? 'active' : ''}`;
            finalDot.textContent = '‚ù§Ô∏è';
            finalDot.title = "Go to Final Page";
            finalDot.onclick = () => { currentIndex = pagesData.length; renderStack(); updateUI(); };
            controls.appendChild(finalDot);
        }

        function togglePreview() {
            const container = document.getElementById('preview-container');
            const frame = document.getElementById('preview-frame');
            const btn = document.querySelector('.stamp-btn');
            const btnText = btn.querySelector('.stamp-text');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                frame.src = "/u/<%= diary.slug %>?preview=true&t=" + new Date().getTime();
                if (btnText) btnText.innerHTML = "Close Preview";
                btn.style.background = "#ffdce0"; // Subtle red tint for "close"

                // Scroll to preview area
                setTimeout(() => {
                    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } else {
                container.style.display = 'none';
                frame.src = "";
                if (btnText) btnText.innerHTML = "Preview";
                btn.style.background = "#fdfbf7"; // Original color
            }
        }

        async function payNow() {
            try {
                const response = await fetch('/create-order', { method: 'POST' });
                const order = await response.json();

                const options = {
                    key: "<%= razorpayKeyId %>",
                    amount: order.amount,
                    currency: order.currency,
                    name: "Valentine's Diary",
                    description: "Unlock & Share Your Story",
                    order_id: order.id,
                    handler: async function (response) {
                        const verifyRes = await fetch('/verify-payment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(response)
                        });
                        const data = await verifyRes.json();
                        if (data.status === "success") {
                            alert("Payment Successful! Your diary is unlocked.");
                            location.reload();
                        } else {
                            alert("Payment Verification Failed!");
                        }
                    },
                    theme: { color: "#6a1b21" }
                };
                const rzp = new Razorpay(options);
                rzp.open();
            } catch (err) {
                console.error(err);
                alert("Could not initiate payment. Check server logs.");
            }
        }
    </script>
</body>

</html>