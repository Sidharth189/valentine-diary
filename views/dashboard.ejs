<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Edit Diary</title>
    <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&display=swap" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        html,
        body {
            overflow-x: hidden;
            max-width: 100%;
        }

        body {
            font-family: 'Indie Flower', cursive;
            background: linear-gradient(135deg, #fff5f5 0%, #fef8f0 100%);
            margin: 0;
            padding: 10px;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .dashboard-layout {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* Reduced gap */
            align-items: center;
            /* Added container bg for contrast */
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(5px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        /* --- 1. Top Section: Payment --- */
        .status-bar {
            width: 100%;
            background: #fff;
            padding: 8px;
            /* Compact */
            transform: rotate(-1deg);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            text-align: center;
            border-radius: 2px;
            position: relative;
            z-index: 200;
        }

        .status-bar::after {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #e74c3c, #c0392b);
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #6a1b21;
            text-shadow: none;
            font-size: 2rem;
            margin: 10px;
            transform: rotate(-2deg);
        }

        /* --- 2. Middle Section: Stacked Pages --- */
        #pages-stack-container {
            width: 100%;
            height: 600px;
            /* Increased Height for better writing space */
            position: relative;
            perspective: 1000px;
        }

        .page-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fffbf0;
            padding: 20px 30px 20px 50px;
            box-sizing: border-box;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 2px;

            /* Lined Paper Lines */
            background-image: linear-gradient(rgba(0, 0, 0, 0.1) 1px, transparent 1px);
            background-size: 100% 25px;
            line-height: 25px;

            /* Initial state: Hidden/Stacked */
            opacity: 0;
            transform: translateX(100%) rotate(10deg);
            pointer-events: none;
            z-index: 0;
            display: flex;
            flex-direction: column;
        }

        .page-item::before {
            display: none;
        }

        /* Active Page State */
        .page-item.active {
            opacity: 1;
            transform: translateX(0) rotate(-1deg);
            pointer-events: all;
            z-index: 10;
        }

        .page-number {
            position: absolute;
            top: -10px;
            right: -5px;
            background: #e74c3c;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            border: 2px solid #fff;
            z-index: 20;
        }

        label {
            display: inline-block;
            font-weight: bold;
            margin-top: 5px;
            padding: 0 5px;
            font-size: 0.9rem;
        }

        textarea,
        input[type="text"] {
            width: 100%;
            padding: 0;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 1.15rem;
            line-height: 30px;
            resize: none;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        /* Dynamic Height Textarea */
        textarea {
            height: calc(100% - 140px);
            /* Fill remaining space */
            margin-top: 5px;
        }

        input[type="text"] {
            height: auto;
        }

        textarea:focus,
        input:focus {
            outline: none;
            background: rgba(41, 128, 185, 0.05);
            /* Subtle blue highlight */
            caret-color: #c0392b;
            /* Red Cursor */
        }

        /* Specific override to ensure cursor visibility */
        textarea {
            caret-color: #c0392b;
        }

        /* --- 3. Controls --- */
        .stack-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            width: 100%;
            background: rgba(253, 251, 247, 0.95);
            /* Stronger cream background */
            padding: 5px 15px;
            border-radius: 50px;
            backdrop-filter: blur(5px);
            margin-top: 20px;
            border: 1px solid #e0d0c0;
            /* Subtle border */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .nav-btn {
            background: #fff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
            color: #5d4037;
        }

        .nav-btn:hover {
            transform: scale(1.1);
            background: #f1c40f;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background: #ddd;
        }

        .btn-delete {
            position: absolute;
            bottom: 10px;
            right: 15px;
            background: transparent;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .btn-delete:hover {
            opacity: 1;
            color: #c0392b;
            transform: scale(1.1);
        }

        /* --- 4. Bottom Actions (Redesigned) --- */
        .action-bar {
            width: 100%;
            display: flex;
            flex-direction: row;
            gap: 30px;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        /* Wax Seal (Save) */
        .wax-seal-btn {
            width: 70px;
            height: 70px;
            background: radial-gradient(circle at 30% 30%, #e74c3c, #c0392b);
            border-radius: 50%;
            border: none;
            color: rgba(255, 255, 255, 0.9);
            font-family: 'Dancing Script', cursive;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow:
                0 4px 6px rgba(0, 0, 0, 0.4),
                inset 2px 2px 5px rgba(255, 255, 255, 0.2),
                inset -2px -2px 5px rgba(0, 0, 0, 0.2),
                0 0 0 4px rgba(192, 57, 43, 0.3);
            /* Irregular edge simulation wrapper */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: rotate(-10deg);
        }

        .wax-seal-btn:hover {
            transform: rotate(-10deg) scale(1.1);
        }

        .wax-seal-btn::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: 1px dashed rgba(255, 255, 255, 0.3);
            border-radius: 50%;
        }

        /* Vintage Stamp (Preview) */
        .stamp-btn {
            background: #fff;
            border: none;
            padding: 10px 15px;
            position: relative;
            color: #2c3e50;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            text-transform: uppercase;
            letter-spacing: 2px;
            transform: rotate(5deg);
            transition: transform 0.2s;

            /* Serrated Edges using radial gradient mask */
            --r: 3px;
            /* radius of circles */
            background: radial-gradient(var(--r) at var(--r) var(--r), #0000 98%, #fffbf0) 0 0 / calc(100% - var(--r)) calc(100% - var(--r)) no-repeat,
                radial-gradient(var(--r) at calc(100% - var(--r)) var(--r), #0000 98%, #fffbf0) 100% 0 / calc(100% - var(--r)) calc(100% - var(--r)) no-repeat,
                radial-gradient(var(--r) at var(--r) calc(100% - var(--r)), #0000 98%, #fffbf0) 0 100% / calc(100% - var(--r)) calc(100% - var(--r)) no-repeat,
                radial-gradient(var(--r) at calc(100% - var(--r)) calc(100% - var(--r)), #0000 98%, #fffbf0) 100% 100% / calc(100% - var(--r)) calc(100% - var(--r)) no-repeat,
                linear-gradient(#fffbf0 0 0) center/ calc(100% - 2*var(--r)) calc(100% - 2*var(--r)) no-repeat,
                radial-gradient(circle at 50% 50%, #fffbf0 0%, #fffbf0 100%);
            /* Simple fallback background if the complex mask is too much, let's stick to a simpler "Postage" look */
            background: #fdfbf7;
            border: 2px dashed #bdc3c7;
            outline: 4px solid #fdfbf7;
        }

        .stamp-btn:hover {
            transform: rotate(5deg) scale(1.1);
            background: #ecf0f1;
        }

        .stamp-text {
            border: 1px solid #333;
            padding: 2px 5px;
            display: inline-block;
            transform: rotate(-2deg);
        }

        .unpaid {
            color: #c0392b;
        }

        /* Polaroid Sync for Dashboard */
        .polaroid-preview {
            background: white;
            padding: 8px 8px 25px 8px;
            /* Classic polaroid bottom bar */
            border: 1px solid #ddd;
            box-shadow: 2px 4px 10px rgba(0, 0, 0, 0.1);
            transform: rotate(-1deg);
            display: inline-block;
            margin: 10px 0;
            max-width: 90%;
        }

        .polaroid-preview img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        /* --- Background Particles --- */
        .bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            color: #6a1b21;
            font-size: 1.2rem;
            text-decoration: none;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        /* --- Responsive Styles --- */
        @media (max-width: 600px) {
            body {
                padding: 5px;
            }

            .dashboard-layout {
                width: 100%;
                max-width: 100%;
                padding: 15px 10px;
                border-radius: 10px;
                margin: 0;
                overflow: hidden;
                /* Prevent internal spill */
            }

            h1 {
                font-size: 1.5rem;
                margin: 5px;
            }

            #pages-stack-container {
                height: 65vh;
                /* Dynamic height for mobile */
                min-height: 400px;
            }

            .page-item {
                padding: 15px 15px 15px 25px;
                /* Smaller padding, less left space */
                background-size: 100% 20px;
                /* Tighter lines */
                line-height: 20px;
            }

            .page-number {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }

            .wax-seal-btn {
                width: 60px;
                height: 60px;
                font-size: 1rem;
            }

            .stamp-btn {
                padding: 8px 10px;
                font-size: 0.9rem;
            }

            .action-bar {
                gap: 15px;
            }

            textarea,
            input[type="text"] {
                font-size: 1rem;
                line-height: 20px;
            }

            .stack-controls {
                padding: 5px 10px;
            }

            .nav-btn {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }

            .polaroid-preview {
                max-width: 100%;
                margin: 5px 0;
                transform: rotate(0deg);
                /* Straighten for better space usage */
                padding: 5px 5px 20px 5px;
            }

            .logout-btn {
                position: fixed;
                top: 10px;
                right: 10px;
                padding: 4px 8px;
                font-size: 0.9rem;
                z-index: 1000;
            }

            .status-bar {
                margin-top: 30px;
                /* Push down to avoid logout button overlap */
                flex-direction: column;
                gap: 5px;
            }

            #preview-container {
                margin-left: 0;
                margin-right: 0;
                border-radius: 8px;
                border-width: 2px;
            }

            .dashboard-layout.preview-active {
                padding: 10px 5px;
            }
        }

        /* Very small screens */
        @media (max-width: 400px) {
            #preview-container {
                border-width: 2px;
                border-radius: 6px;
                margin: 10px 0;
            }
        }

        .dashboard-layout {
            max-width: 600px;
            width: 95%;
            margin: 0 auto;
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Core centering */
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Preview Container Styling */
        #preview-container {
            display: none;
            width: 100%;
            max-width: 100%;
            margin: 20px 0;
            border: 4px solid #fff;
            border-radius: 12px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
            background: #111;
            position: relative;
            overflow: hidden;
            z-index: 1000;
            box-sizing: border-box;
        }

        #preview-container iframe {
            /* Fixed internal resolution - diary sees a full desktop viewport */
            width: 900px;
            height: 700px;
            border: none;
            background: white;
            display: block;
            transform-origin: top left;
            /* Scale is set dynamically by JS */
        }

        /* Wrapper clips the iframe at its scaled visual size */
        .iframe-wrapper {
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .dashboard-layout.preview-active {
            max-width: 100%;
            width: 100%;
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Center non-preview elements when expanded */
        .dashboard-layout.preview-active>*:not(#preview-container) {
            max-width: 500px;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>

<body>

    <!-- Body Content -->
    <canvas class="bg-particles" id="bg-canvas"></canvas>

    <!-- Logout Button (Fixed Top Right) -->
    <a href="/logout" class="logout-btn">Logout &#10060;</a>

    <div class="dashboard-layout">

        <!-- 1. Payment Status (Top) -->
        <div class="status-bar">
            <span style="font-weight:bold; font-size:1rem; color:#333;">STATUS:</span>
            <span class="<%= diary.isPaid ? 'paid' : 'unpaid' %>" style="font-weight:bold;">
                <%= diary.isPaid ? 'PAID' : 'LOCKED' %>
            </span>
            <% if (!diary.isPaid) { %>
                <button onclick="payNow()"
                    style="background:#c0392b; color:white; border:none; padding:5px 12px; border-radius:20px; cursor:pointer; font-family:inherit; font-weight:bold; margin-left:10px; font-size:0.9rem;">
                    Pay Rs 9 to Unlock</button>
                <% } else { %>
                    <span style="color:#2980b9; margin: 0 5px;">|</span>
                    <a href="/u/<%= diary.slug %>" target="_blank"
                        style="color:#2980b9; text-decoration:none; font-weight:bold;">Visit Link</a>
                    <span style="color:#2980b9; margin: 0 5px;">|</span>
                    <button
                        onclick="navigator.clipboard.writeText(window.location.origin + '/u/<%= diary.slug %>'); alert('Link Copied! \u2705')"
                        style="background:none; border:none; color:#2980b9; font-weight:bold; cursor:pointer; font-family:inherit; font-size:1rem; padding:0; text-decoration:underline;"
                        title="Copy to clipboard">Copy Link</button>
                    <% } %>
        </div>

        <h1>My Diary Pages</h1>

        <form id="diary-form" action="/dashboard/save" method="POST" style="width:100%;">

            <!-- 2. Interactive Page Stack -->
            <div id="pages-stack-container">
                <!-- Pages injected via JS -->
            </div>

            <!-- 3. Navigation & Add Controls -->
            <div class="stack-controls">
                <button type="button" class="nav-btn" onclick="goToFirst()" title="Go to Cover">|&laquo;</button>
                <button type="button" class="nav-btn" id="btn-prev" onclick="changePage(-1)">&#8592;</button>

                <div style="text-align:center; color:#3e2723;">
                    <span id="current-page-display"
                        style="font-size:1.1rem; font-weight:bold; min-width: 80px; display:inline-block;">Cover</span>
                    <span style="margin:0 5px; opacity:0.5;">|</span>
                    <button type="button" class="btn-add" onclick="addPage()"
                        style="background:none; border:none; color:#f1c40f; text-decoration:underline; cursor:pointer; font-family:inherit; font-weight:bold;">+
                        Add Page</button>
                </div>

                <button type="button" class="nav-btn" id="btn-next" onclick="changePage(1)">&#8594;</button>
                <button type="button" class="nav-btn" onclick="goToLast()" title="Go to Final Page">&raquo;|</button>
            </div>

            <!-- 4. Save & Preview (Bottom) -->
            <div class="action-bar">
                <button type="submit" class="wax-seal-btn" title="Seal & Save">Save</button>
                <div style="width: 20px;"></div> <!-- Spacer -->

                <button type="button" class="stamp-btn" onclick="togglePreview()" title="Preview Diary">
                    <span class="stamp-text">Preview</span>
                </button>
            </div>

            <!-- 5. Live Preview Section -->
            <div id="preview-container" style="display:none;">
                <button type="button" onclick="togglePreview()"
                    style="position:absolute; top:10px; right:10px; background:#e74c3c; color:white; border:2px solid #fff; border-radius:50%; width:35px; height:35px; cursor:pointer; font-weight:bold; font-size:1.2rem; z-index:10; display:flex; align-items:center; justify-content:center;">&times;</button>
                <div
                    style="color:white; padding:10px; text-align:center; font-size:1.1rem; font-weight:bold; background:rgba(0,0,0,0.5);">
                    ✨ Live Diary Preview
                </div>
                <div class="iframe-wrapper" id="iframe-wrapper">
                    <iframe id="preview-frame"></iframe>
                </div>
            </div>

        </form>
    </div>

    <!-- Data -->
    <!-- Server Data Payload -->
    <script id="server-data" type="application/json">
        <%- JSON.stringify({
            pages: diary.pages || [],
            diary: {
                title: diary.title,
                description: diary.description,
                finalQuestion: diary.finalQuestion,
                yesLabel: diary.yesLabel,
                noLabel: diary.noLabel,
                successMessage: diary.successMessage
            }
        }) %>
    </script>



    <script>
        console.log("Dashboard Script Initializing...");

        // --- Data & State ---

        // Initialize Data safely from JSON script output
        let serverData;
        try {
            serverData = JSON.parse(document.getElementById('server-data').textContent);
        } catch (e) {
            console.error("Data Parse Error", e);
            serverData = { pages: [], diary: {} };
        }

        let pagesData = serverData.pages || [];
        const diary = serverData.diary || {};

        // Cover Data State
        let coverData = {
            title: diary.title || '',
            description: diary.description || ''
        };


        if (pagesData.length < 1) {
            pagesData.push({ text: '', imageUrl: '' });
        }

        // Start at Cover (-1)
        let currentIndex = -1;

        const container = document.getElementById('pages-stack-container');
        const displayCount = document.getElementById('current-page-display');
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');

        // --- Init ---
        renderStack();
        updateUI();

        // --- Core Functions ---

        function goToFirst() {
            currentIndex = -1;
            renderStack();
            updateUI();
        }

        function goToLast() {
            currentIndex = pagesData.length;
            renderStack();
            updateUI();
        }

        function renderStack() {
            container.innerHTML = '';

            // --- 1. RENDER COVER (Index -1) ---
            const coverDiv = document.createElement('div');
            coverDiv.className = 'page-item';

            // Leather Style Cover
            coverDiv.style.background = "#6a1b21";
            coverDiv.style.backgroundImage = "radial-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px), radial-gradient(rgba(0, 0, 0, 0.1) 1px, transparent 1px)";
            coverDiv.style.backgroundSize = "4px 4px, 5px 5px";
            coverDiv.style.border = "none";
            coverDiv.style.boxShadow = "inset 0 0 20px rgba(0,0,0,0.6)";
            coverDiv.style.display = "flex";
            coverDiv.style.flexDirection = "column";
            coverDiv.style.justifyContent = "center";
            coverDiv.style.alignItems = "center";
            coverDiv.style.zIndex = 50;

            if (currentIndex === -1) coverDiv.classList.add('active');
            else if (currentIndex > -1) coverDiv.classList.add('prev');

            coverDiv.innerHTML = `
                <div class="page-number" style="background:#444; color:#fff; border-color:#666;">C</div>
                
                <label style="color:#e6c278; font-size:0.8rem;">Cover Title <small style="color:#ccc;">(<span id="char-count-title">${(coverData.title || '').length}</span>/100)</small></label>
                <input type="text" name="title" maxlength="100" value="${coverData.title}" oninput="coverData.title=this.value; document.getElementById('char-count-title').textContent=this.value.length" placeholder="Title..."
                    style="background:transparent; border:none; border-bottom:2px solid #e6c278; color:#e6c278; font-size:2.5rem; text-align:center; font-family:'Dancing Script'; width:90%; margin-bottom:20px; text-shadow:1px 1px 2px black; outline:none; height:auto;">
                
                <label style="color:#e6c278; font-size:0.8rem;">Cover Description <small style="color:#ccc;">(<span id="char-count-desc">${(coverData.description || '').length}</span>/200)</small></label>
                <textarea name="description" maxlength="200" oninput="coverData.description=this.value; document.getElementById('char-count-desc').textContent=this.value.length" placeholder="Description..."
                    style="background:transparent; border:1px solid #e6c278; color:#fff; width:70%; height:80px !important; flex-grow:0; border-radius:5px; padding:5px; font-family:'Indie Flower'; font-size:1.1rem !important; text-align:center; outline:none;">${coverData.description}</textarea>
            `;
            container.appendChild(coverDiv);

            // --- 2. RENDER PAGES (Index 0..N) ---
            pagesData.forEach((page, index) => {
                const div = document.createElement('div');
                div.className = `page-item`;

                if (index === currentIndex) div.classList.add('active');
                else if (index < currentIndex) div.classList.add('prev');

                const isImageFirst = page.layout === 'image-first';

                const imageSection = `
                    <div style="margin: 0; text-align: center; position:relative; width:100%; display: ${page.imageUrl ? 'block' : 'none'};">
                        <div class="polaroid-preview" style="transform: rotate(${index % 2 === 0 ? '-2deg' : '2deg'});">
                            <img id="preview-${index}" src="${page.imageUrl || ''}">
                        </div>
                        
                        <!-- Upload Button (Floating) -->
                        <label for="file-${index}" title="Upload Image" style="position:absolute; top:10px; right:10px; font-size:1.5rem; cursor:pointer; z-index:15; transition:transform 0.2s; background:rgba(255,255,255,0.7); border-radius:50%; padding:5px;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                            &#128444;&#65039;
                        </label>
                        <input type="file" id="file-${index}" accept="image/*" style="display:none;" onchange="handleFileUpload(this, ${index})">
                        <span id="upload-status-${index}" style="position:absolute; top:45px; right:15px; font-size:0.7rem; color:#27ae60; font-weight:bold;"></span>
                    </div>
                    
                    <!-- Placeholder when no image is uploaded -->
                    <div id="image-placeholder-${index}" style="display: ${page.imageUrl ? 'none' : 'block'}; margin: 10px 0; padding: 20px; border: 2px dashed #ccc; text-align:center; position:relative;">
                        <span style="opacity:0.5;">No Photo Added</span>
                        <label for="file-${index}" style="position:absolute; inset:0; cursor:pointer; font-size:0;"></label>
                        <span id="upload-status-placeholder-${index}" style="display:block; font-size:0.7rem; color:#27ae60; font-weight:bold;"></span>
                    </div>`;

                const textSection = `
                    <label style="margin-top:0;">&#128221; Story: <small style="color:#666; float:right;">(<span id="char-count-${index}">${(page.text || '').length}</span>/500)</small></label>
                    <textarea name="pages[${index}][text]" maxlength="500" placeholder="Once upon a time..." 
                        style="width: 100%; height: 200px; padding: 5px 0; border: none; background: transparent; resize: vertical; line-height: 25px;"
                        oninput="updateData(${index}, 'text', this.value); updateCharCount(this, ${index})">${page.text || ''}</textarea>
                    
                    <input type="hidden" name="pages[${index}][imageUrl]" value="${page.imageUrl}" id="hidden-img-${index}">
                    <input type="hidden" name="pages[${index}][layout]" value="${page.layout || 'text-first'}" id="layout-${index}">`;

                div.innerHTML = `
                    <div class="page-number">${index + 1}</div>
                    
                    <div style="text-align:right; margin-bottom:5px;">
                        <button type="button" onclick="toggleLayout(${index})" style="font-size:1.2rem; padding:2px 5px; background:none; border:none; cursor:pointer;" title="Swap Text/Image Position">
                            ${isImageFirst ? '&#11015;&#65039;' : '&#11014;&#65039;'}
                        </button>
                    </div>

                    ${isImageFirst ? imageSection + textSection : textSection + imageSection}
                    
                    <button type="button" class="btn-delete" onclick="deletePage(${index})" title="Delete Page" style="font-size:1.2rem; background:none; border:none;">&#128465;&#65039;</button>
                `;
                container.appendChild(div);
            });

            // --- 3. RENDER FINAL PAGE (Index = pagesData.length) ---
            const finalDiv = document.createElement('div');
            finalDiv.className = 'page-item';

            // Special styling for Final Page
            finalDiv.style.background = "#fff0f5"; // Lavender blush
            finalDiv.style.border = "2px solid #e91e63"; // Pink border
            finalDiv.style.display = "flex";
            finalDiv.style.flexDirection = "column";
            finalDiv.style.alignItems = "center";
            finalDiv.style.justifyContent = "center";
            finalDiv.style.textAlign = "center";

            if (currentIndex === pagesData.length) finalDiv.classList.add('active');
            else if (currentIndex > pagesData.length) finalDiv.classList.add('prev'); // Should not happen

            finalDiv.innerHTML = `
                <div class="page-number" style="background:#e91e63;">End</div>
                
                <h3 style="color:#c2185b; margin-bottom:15px; font-family:'Indie Flower';">&#10084;&#65039; The Big Question &#10084;&#65039;</h3>
                
                <label style="color:#880e4f; font-weight:bold;">Your Question:</label>
                <input type="text" name="finalQuestion" value="${diary.finalQuestion || 'Will you be my Valentine?'}" 
                    oninput="diary.finalQuestion=this.value" placeholder="Will you be my Valentine?"
                    style="width:90%; padding:8px; margin-bottom:15px; border:1px solid #f48fb1; border-radius:5px; text-align:center; font-size:1.1rem; color:#880e4f;">

                <div style="display:flex; gap:10px; width:90%; margin-bottom:15px;">
                    <div style="flex:1;">
                        <label style="color:#2ecc71; font-weight:bold;">Yes Button:</label>
                        <input type="text" name="yesLabel" value="${diary.yesLabel || 'Yes! &#10084;&#65039;'}" 
                            oninput="diary.yesLabel=this.value" placeholder="Yes! &#10084;&#65039;"
                            style="width:100%; padding:5px; border:1px solid #a5d6a7; border-radius:5px; text-align:center;">
                    </div>
                    <div style="flex:1;">
                        <label style="color:#e74c3c; font-weight:bold;">No Button:</label>
                        <input type="text" name="noLabel" value="${diary.noLabel || 'No'}" 
                            oninput="diary.noLabel=this.value" placeholder="No"
                            style="width:100%; padding:5px; border:1px solid #ef9a9a; border-radius:5px; text-align:center;">
                    </div>
                </div>

                <label style="color:#ad1457; font-weight:bold;">Success Message (After Yes):</label>
                <textarea name="successMessage" placeholder="Yay! I love you! &#10084;&#65039;" 
                    oninput="diary.successMessage=this.value"
                    style="width:90%; height:60px; padding:5px; border:1px solid #f48fb1; border-radius:5px; text-align:center; resize:none;">${diary.successMessage || 'Yay! &#10084;&#65039; I love you!'}</textarea>
            `;
            container.appendChild(finalDiv);
        }

        function toggleLayout(index) {
            const currentLayout = pagesData[index].layout || 'text-first';
            pagesData[index].layout = currentLayout === 'image-first' ? 'text-first' : 'image-first';
            renderStack();
        }

        function updateData(index, field, value) {
            pagesData[index][field] = value;
        }

        function updateCharCount(textarea, index) {
            const currentLength = textarea.value.length;
            const counter = document.getElementById(`char-count-${index}`);
            if (counter) counter.textContent = currentLength;
        }

        async function handleFileUpload(input, index) {
            const file = input.files[0];
            if (!file) return;

            const statusSpan = document.getElementById(`upload-status-${index}`);
            statusSpan.textContent = "Uploading...";

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                if (!response.ok) throw new Error("Upload Failed");

                const data = await response.json();
                if (data.imageUrl) {
                    pagesData[index].imageUrl = data.imageUrl;
                    document.getElementById(`hidden-img-${index}`).value = data.imageUrl;
                    const preview = document.getElementById(`preview-${index}`);
                    preview.src = data.imageUrl;
                    preview.style.display = 'inline-block';
                    statusSpan.textContent = "Done!";
                } else {
                    statusSpan.textContent = "Error";
                }
            } catch (err) {
                console.error(err);
                statusSpan.textContent = "Failed";
                alert("Upload failed.");
            }
        }

        async function saveDiary(event) {
            event.preventDefault();

            // Validation: Enforce Odd Page Count
            if (pagesData.length % 2 === 0 && pagesData.length > 0) {
                alert("Please add one more page! \n\nSince the content starts on the inner cover, the diary requires an odd number of pages (1, 3, 5, etc.) to look perfect.");
                return;
            }

            const form = document.getElementById('diary-form');
            const statusDiv = document.getElementById('save-status');

            statusDiv.textContent = "Saving...";
            statusDiv.style.opacity = 1;

            // Prepare Data
            const formData = {
                cover: coverData,
                pages: pagesData
            };

            try {
                const response = await fetch('/save-diary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    statusDiv.innerHTML = "Saved Successfully! &#128150;";
                    setTimeout(() => { statusDiv.style.opacity = 0; }, 3000);
                    refreshPreview();
                } else {
                    throw new Error("Save failed");
                }
            } catch (err) {
                console.error(err);
                statusDiv.textContent = "Error Saving!";
                alert("Failed to save diary.");
            }
        }

        function changePage(direction) {
            const newIndex = currentIndex + direction;
            // Allow range from -1 (Cover) to pagesData.length (Final Page)
            if (newIndex >= -1 && newIndex <= pagesData.length) {
                currentIndex = newIndex;
                renderStack();
                updateUI();
            }
        }

        function addPage() {
            if (pagesData.length >= 10) { alert("Max 10 pages!"); return; }
            pagesData.push({ text: "", imageUrl: "", layout: 'image-first' }); // Default to Image First as per recent change
            currentIndex = pagesData.length - 1;
            renderStack();
            updateUI();
        }

        function deletePage(index) {
            if (pagesData.length <= 1) { alert("Keep at least 1 page!"); return; }
            if (confirm("Delete this page?")) {
                pagesData.splice(index, 1);
                currentIndex = Math.max(-1, index - 1);
                renderStack();
                updateUI();
            }
        }

        function updateUI() {
            if (currentIndex === -1) displayCount.textContent = `Cover`;
            else if (currentIndex === pagesData.length) displayCount.textContent = `Final`;
            else displayCount.textContent = `${currentIndex + 1} / ${pagesData.length}`;

            btnPrev.disabled = currentIndex === -1;
            btnNext.disabled = currentIndex === pagesData.length; // Disable next if at Final Page

            // Hide Add Page button on Cover (-1) and Final Page
            const btnAdd = document.querySelector('.btn-add');
            if (btnAdd) {
                btnAdd.style.display = (currentIndex === -1 || currentIndex === pagesData.length) ? 'none' : 'inline-block';
            }
        }

        function resizePreviewFrame() {
            const frame = document.getElementById('preview-frame');
            const wrapper = document.getElementById('iframe-wrapper');
            const container = document.getElementById('preview-container');
            if (!frame || !wrapper || container.style.display === 'none') return;

            // Fixed internal iframe size (desktop-like viewport)
            const iframeW = 900;
            const iframeH = 700;

            // Scale to fit container width
            const containerWidth = container.clientWidth;
            const scale = containerWidth / iframeW;

            // Apply CSS transform scale to the iframe
            frame.style.width = iframeW + 'px';
            frame.style.height = iframeH + 'px';
            frame.style.transform = `scale(${scale})`;
            frame.style.transformOrigin = 'top left';

            // Set wrapper height to the resulting visual height
            wrapper.style.height = (iframeH * scale) + 'px';
        }

        // Listen for resize to keep preview responsive
        window.addEventListener('resize', resizePreviewFrame);

        function togglePreview() {
            const container = document.getElementById('preview-container');
            const frame = document.getElementById('preview-frame');
            const btn = document.querySelector('.stamp-btn');
            const btnText = btn.querySelector('.stamp-text');
            const layout = document.querySelector('.dashboard-layout');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                layout.classList.add('preview-active');
                frame.src = "/u/<%= diary.slug %>?preview=true&t=" + new Date().getTime();
                if (btnText) btnText.innerHTML = "Close Preview";
                btn.style.background = "#ffdce0";

                // Resize iframe to fit, then scroll into view
                setTimeout(() => {
                    resizePreviewFrame();
                    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } else {
                container.style.display = 'none';
                layout.classList.remove('preview-active');
                frame.src = "";
                if (btnText) btnText.innerHTML = "Preview";
                btn.style.background = "#fdfbf7";
            }
        }

        async function payNow() {
            try {
                const response = await fetch('/create-order', { method: 'POST' });
                const order = await response.json();

                const options = {
                    key: "<%= razorpayKeyId %>",
                    amount: order.amount,
                    currency: order.currency,
                    name: "Valentine's Diary",
                    description: "Unlock & Share Your Story",
                    order_id: order.id,
                    handler: async function (response) {
                        const verifyRes = await fetch('/verify-payment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(response)
                        });
                        const data = await verifyRes.json();
                        if (data.status === "success") {
                            alert("Payment Successful! Your diary is unlocked.");
                            location.reload();
                        } else {
                            alert("Payment Verification Failed!");
                        }
                    },
                    theme: { color: "#6a1b21" }
                };
                const rzp = new Razorpay(options);
                rzp.open();
            } catch (err) {
                console.error(err);
                alert("Could not initiate payment. Check server logs.");
            }
        }

        // --- Sparkle/Particle Background Script ---
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        let particles = [];
        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 1;
                this.speedX = Math.random() * 0.5 - 0.25;
                this.speedY = Math.random() * 0.5 - 0.25;
                this.alpha = Math.random();
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.x > canvas.width) this.x = 0;
                if (this.x < 0) this.x = canvas.width;
                if (this.y > canvas.height) this.y = 0;
                if (this.y < 0) this.y = canvas.height;
            }
            draw() {
                // Using primary color with higher opacity
                ctx.fillStyle = `rgba(106, 27, 33, ${this.alpha * 0.5})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initParticles() {
            particles = [];
            for (let i = 0; i < 100; i++) {
                particles.push(new Particle());
            }
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }

        initParticles();
        animate();
    </script>
</body>

</html>